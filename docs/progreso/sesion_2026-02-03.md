# Sesión 2026-02-03 - Resumen de Progreso

## Tareas Completadas

### 1. Fix Catalunya Adapter (Imágenes + Provincias)
**Archivo:** `src/adapters/gold_api_adapter.py`

**Problemas resueltos:**
- `image_url_prefix` era incorrecto (`https://gencat.cat` → `https://agenda.cultura.gencat.cat`)
- No se extraía la provincia del campo `municipi`

**Cambios:**
- Línea ~107: Cambiado `image_url_prefix`
- Líneas ~1019-1035: Añadido parsing de provincia desde `municipi` (formato: `agenda:ubicacions/{provincia}/{comarca}/{municipio}`)
- Mapeo de provincias catalanas: barcelona, girona, lleida, tarragona

**Campos nuevos mapeados para Catalunya:**
- `modalitat` → `location_type` (Presencial/Online/Híbrid)
- `destacada` → `is_featured` (Si/No)

### 2. Fix Madrid Imágenes
**Problema:** La API de Madrid NO tiene campo de imagen

**Solución implementada:**
1. LLM genera `image_keywords` (3 palabras en inglés)
2. Busca en Unsplash (fallback a Pexels)
3. Guarda en `source_image_url` Y `image_url`

**Gotcha descubierto:** Al hacer UPDATE directo, hay que actualizar AMBOS campos (`source_image_url` e `image_url`). El INSERT lo hace automáticamente, pero UPDATE no.

### 3. Limpieza de Textos - remove_boilerplate()
**Archivo:** `src/adapters/gold_api_adapter.py` (función `remove_boilerplate`)

**Elimina automáticamente:**
- "Para más información...", "Más info en..."
- "Consulte nuestra web", "Contacte con nosotros"
- "¡No te lo pierdas!", "¡Te esperamos!", "¡Apúntate!"
- "Aforo limitado", "Sujeto a cambios"
- "Síguenos en @...", menciones de redes sociales
- "Próximamente más información", "Pendiente de confirmar"

Se llama automáticamente desde `clean_html()`.

### 4. Fix City Extraction
**Archivo:** `src/adapters/gold_api_adapter.py` - `_extract_city()`

Corregido para convertir hyphens en espacios en nombres de ciudades extraídos de URLs:
- `sant-andreu-de-la-barca` → `Sant Andreu De La Barca`

---

## Eventos Insertados Esta Sesión

| Fuente | Cantidad | Provincias |
|--------|----------|------------|
| Catalunya | 19 | Barcelona, Girona, Lleida, Tarragona |
| Madrid | 10 | Madrid |

---

## Configuración de Modelos LLM por Tier

| Tier | Modelo | Fuentes |
|------|--------|---------|
| ORO | `gpt-oss-120b` (Groq) | Madrid, Catalunya, Euskadi, CyL, Andalucía |
| PLATA | `llama-3.3-70b` (Groq) | Semi-estructuradas |
| BRONCE | `kimi-k2` (Groq) | Web scraping |

---

## Gotchas Importantes

1. **Groq trunca JSON largos** → Reducir `batch_size` de 10 a 5
2. **UPDATE imágenes** → Actualizar `source_image_url` Y `image_url`
3. **Upsert no funciona** → No hay constraint UNIQUE en `external_id`

---

## Archivos Modificados

```
src/adapters/gold_api_adapter.py
  - image_url_prefix Catalunya
  - _extract_province() - Catalunya
  - _extract_city() - fix hyphens
  - field_mappings Catalunya (modalitat, destacada)
  - parse_event() - location_type, is_featured
  - remove_boilerplate() - NUEVA función
  - clean_html() - llama a remove_boilerplate()
```

---

## Próximos Pasos Sugeridos

- [ ] Añadir más fuentes Bronze (scraping)
- [ ] Mejorar detección de eventos gratuitos
- [ ] Probar inserción masiva de todas las CCAA
- [ ] Validar imágenes de otras fuentes (Euskadi, CyL, Andalucía)
